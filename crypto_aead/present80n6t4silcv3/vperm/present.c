#include "present.h"
#include <string.h>
dqword rks[32];

ALIGN16(unsigned char PRESENTInShuffleU[]) = {
	0x08, 0x08, 0x09, 0x09, 0x0A, 0x0A, 0x0B, 0x0B,
	0x0C, 0x0C, 0x0D, 0x0D, 0x0E, 0x0E, 0x0F, 0x0F
};

ALIGN16(unsigned char PRESENTInShuffleL[]) = {
	0x00, 0x00, 0x01, 0x01, 0x02, 0x02, 0x03, 0x03,
	0x04, 0x04, 0x05, 0x05, 0x06, 0x06, 0x07, 0x07
};

ALIGN16(unsigned char PRESENTOutShuffleU[]) = {
	0x00, 0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0E,
	0x01, 0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F
};

ALIGN16(unsigned char PRESENTOutShuffleL[]) = {
	0x01, 0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F,
    0x00, 0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0E
};

ALIGN16(unsigned char FormatInputMask1[]) = {
    0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0,
    0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0
};

ALIGN16(unsigned char FormatInputMask2[]) = {
    0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00,
    0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00
};

ALIGN16(unsigned char FormatInputMask3[]) = {
    0x00, 0x0F, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x0F,
    0x00, 0x0F, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x0F
};

ALIGN16(unsigned char FormatInputMask4[]) = {
    0x0F, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x0F, 0x00,
    0x0F, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x0F, 0x00
};

ALIGN16(unsigned char PRESENTOUTMASK[]) = {
    0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F,
    0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0
};

ALIGN16(unsigned char PRESENTPlayerMask1[]) = {
	0xCC, 0xCC, 0x00, 0x00, 0xCC, 0xCC, 0x00, 0x00,
	0xCC, 0xCC, 0x00, 0x00, 0xCC, 0xCC, 0x00, 0x00
};

ALIGN16(unsigned char PRESENTPlayerMask2[]) = {
	0xAA, 0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 0x00,
	0xAA, 0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 0x00
};

ALIGN16(unsigned char PRESENTPlayerShuffle[]) = {
	0x00, 0x04, 0x08, 0x0C, 0x01, 0x05, 0x09, 0x0D,
	0x02, 0x06, 0x0A, 0x0E, 0x03, 0x07, 0x0B, 0x0F
};

ALIGN16(unsigned char PRESENTKeyMask[]) = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F,
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0F
};

ALIGN16(unsigned char PRESENTSBoxL[])  = {0x0c, 0x05, 0x06, 0x0b, 0x09, 0x00, 0x0a, 0x0d, 0x03, 0x0e, 0x0f, 0x08, 0x04, 0x07, 0x01, 0x02};
ALIGN16(unsigned char PRESENTSBoxH[])  = {0xc0, 0x50, 0x60, 0xb0, 0x90, 0x00, 0xa0, 0xd0, 0x30, 0xe0, 0xf0, 0x80, 0x40, 0x70, 0x10, 0x20};

ALIGN16(unsigned char PRESENTRCounter80[]) = {
	0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x4c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x4c, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x54, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x54, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x5c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x5c, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x60, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x74, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00
};



//now: a15a14a13...a1a0 b15b14...b1b0
void format_input(dqword *state){
	dqword tmp = PSHUFB(*state, LOAD(PRESENTInShuffleU));
	*state = PSHUFB(*state, LOAD(PRESENTInShuffleL));
    tmp = ORDQW(ANDDQW(tmp, LOAD(FormatInputMask1)), ANDDQW(SRLW(tmp, 4), LOAD(FormatInputMask2)));
    *state = ORDQW(ANDDQW(*state, LOAD(FormatInputMask4)), ANDDQW(SRLW(*state, 4), LOAD(FormatInputMask3)));
    *state = XORDQW(*state, tmp);
}

//input: a15b15 ... a0b0
void format_output(dqword *state){
    //a15b15 a13b13 ... a3b3 a1b1 a14b14 a12b12 ... a0b0
	dqword tmp = PSHUFB(*state, LOAD(PRESENTOutShuffleU));
	//a14b14  a12b12 ... a2b2 a0b0 a15b15  a13b13 ... a1b1
	*state = PSHUFB(*state, LOAD(PRESENTOutShuffleL));
	dqword tmpstate = MASK128U(XORDQW(MASK4U(tmp), MASK4L(SRLQW(*state, 4))));
	tmp = MASK128L(XORDQW(MASK4L(tmp), MASK4U(SLLQW(*state, 4))));
    *state = ORDQW(tmpstate, tmp);
}

void bit_permutation(dqword *state, dqword mask, int shift){
	dqword tmp = SRLDW(*state, shift);
	tmp = XORDQW(tmp, *state);
	tmp = ANDDQW(tmp, mask);
	dqword out = SLLDW(tmp, shift);
	tmp = XORDQW(tmp, *state);
	*state = XORDQW(out, tmp);
}

/*
key1: k79k78...k16 k79k78...k16
key2: k15k14...k0  |  k15k14...k0
*/
void key_schedule(dqword *key1, dqword *key2, int roundid){

	//[k38, k37, k36, k35, k34] = [k38, k37, k36, k35, k34] ^ round_counter
	dqword test = LOAD(PRESENTRCounter80 + roundid*16*sizeof(unsigned char));
	*key1 = XORDQW(*key1, LOAD(PRESENTRCounter80 + roundid*16*sizeof(unsigned char)));
	//[k79, k78, ..., k1, k0] = [k18, k17, ..., k20, k19]
	dqword tmp = XORDQW(SLLQW(*key1, 61), SLLQW(*key2, 45));
	*key2 = SRLQW(SLLQW(*key1, 45), 48);
	*key1 = XORDQW(SRLQW(*key1, 19), tmp);
	//[k79, k78, k77, k76] = Sbox[k79, k78, k77, k76]
	
	test = ORDQW(*key1, LOAD(PRESENTKeyMask));
	test = SRLQW(test, 4);
	test = PSHUFB(LOAD(PRESENTSBoxL), test);
	tmp = SLLQW(PSHUFB(LOAD(PRESENTSBoxL), SRLQW(ORDQW(*key1, LOAD(PRESENTKeyMask)), 4)), 4);
	*key1 = XORDQW(tmp, ANDDQW(*key1, LOAD(PRESENTKeyMask)));
}

void pLayer(dqword *state){
	bit_permutation(state, LOAD(PRESENTPlayerMask1), 14);
	bit_permutation(state, LOAD(PRESENTPlayerMask2), 7);
	*state = PSHUFB(*state, LOAD(PRESENTPlayerShuffle));
}

void addRoundKey(dqword *state, dqword *key){
	// format_input(&key);
	*state = XORDQW(*state, *key);
}

void sBoxLayer(dqword *state){
	*state = XORDQW(PSHUFB(LOAD(PRESENTSBoxL), MASK4L(*state)), PSHUFB(LOAD(PRESENTSBoxH), MASK4L(SRLDW(*state, 4))));
}


void PRESENT80_InitKEY(const unsigned char* userkey){
	ALIGN16(unsigned char tk[16]);
	memset(tk, 0, sizeof(tk));
	memcpy(tk, userkey, 2);
	memcpy(tk+8, userkey, 2);
	dqword lowkey = LOAD(tk);
	memcpy(tk, userkey+2, 8);
	memcpy(tk+8, userkey+2, 8);
	dqword highkey = LOAD(tk);
	rks[0] = highkey;
	format_input(&rks[0]);
	for(int i=0; i<31; i++){
        key_schedule(&highkey, &lowkey, i);
        rks[i+1] = highkey;
        format_input(&rks[i+1]);
	}
}


void PRESENT80_enc(dqword *input, const unsigned char* userkey){
	format_input(input);
	for(int i=0; i<31; i++){
		addRoundKey(input, &rks[i]);
		sBoxLayer(input);
		pLayer(input);
	}
	addRoundKey(input, &rks[31]);
	format_output(input);
}
